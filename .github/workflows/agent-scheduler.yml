# CouchPotato Agent Scheduler
# ============================
# Runs automated agent tasks on three cadences:
#   Nightly  — 2 AM UTC every day      (uptime, SSL checks)
#   Weekly   — 3 AM UTC every Monday   (+ header analysis)
#   Monthly  — 4 AM UTC on the 1st     (+ full AI report)
#
# Can also be triggered manually from Actions tab with any schedule.
#
# Required repository secrets (Settings → Secrets → Actions):
#   ANTHROPIC_API_KEY   — Claude API key for AI analysis
#   TELEGRAM_TOKEN      — Telegram bot token for notifications
#   TELEGRAM_CHAT_ID    — Your Telegram chat ID
#   GH_PAT              — Personal access token (repo scope) for pushing results

name: Agent Scheduler

on:
  schedule:
    - cron: '0 2 * * *'    # Nightly — every day at 2 AM UTC
    - cron: '0 3 * * 1'    # Weekly  — Monday at 3 AM UTC
    - cron: '0 4 1 * *'    # Monthly — 1st of month at 4 AM UTC
  workflow_dispatch:
    inputs:
      schedule:
        description: 'Which schedule to run'
        required: true
        default: 'nightly'
        type: choice
        options:
          - nightly
          - weekly
          - monthly

permissions:
  contents: write

jobs:
  run-agents:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT || github.token }}

      - name: Determine schedule type
        id: schedule
        run: |
          case "${{ github.event.schedule }}" in
            "0 2 * * *") echo "type=nightly"  >> $GITHUB_OUTPUT ;;
            "0 3 * * 1") echo "type=weekly"   >> $GITHUB_OUTPUT ;;
            "0 4 1 * *") echo "type=monthly"  >> $GITHUB_OUTPUT ;;
            *)            echo "type=${{ inputs.schedule }}" >> $GITHUB_OUTPUT ;;
          esac

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install anthropic aiohttp

      - name: Run agent
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          SCHEDULE: ${{ steps.schedule.outputs.type }}
        run: |
          python automation/agent_runner.py --schedule $SCHEDULE

      - name: Commit reports
        run: |
          git config user.name  "CouchPotato Agent"
          git config user.email "agent@couchpotato.local"
          git add reports/
          git diff --staged --quiet && echo "No new reports." || (
            git commit -m "agent: ${{ steps.schedule.outputs.type }} run $(date -u +%Y-%m-%d)"
            git push
          )
